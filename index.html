<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fashion Boutique - Professional Online Shopping</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      color: #1a1a1a;
    }

    .header {
      background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
      color: white;
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      color: white;
      text-decoration: none;
      cursor: pointer;
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 2rem;
      align-items: center;
    }

    .nav-menu a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .cart-icon {
      position: relative;
      font-size: 1.5rem;
      cursor: pointer;
      user-select: none;
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero {
      background:
        linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4)),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%23667eea" width="1200" height="600"/></svg>');
      background-size: cover;
      color: white;
      padding: 6rem 2rem 4rem;
      text-align: center;
    }

    .hero h1 {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      font-weight: 800;
    }

    .filter-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-bottom: 2px solid #ddd;
    }

    .filter-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.7rem 1.3rem;
      border: 2px solid #2d3436;
      background: white;
      color: #2d3436;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
    }

    .filter-btn.active {
      background: #2d3436;
      color: white;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2rem;
      max-width: 1400px;
      margin: 3rem auto;
      padding: 0 2rem;
    }

    .product-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }

    .product-card:hover { transform: translateY(-10px); }

    .product-image {
      width: 100%;
      height: 320px;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-details { padding: 1.5rem; }

    .product-category {
      font-size: 0.85rem;
      color: #636e72;
      text-transform: uppercase;
      font-weight: 600;
    }

    .product-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }

    .product-price {
      font-size: 1.4rem;
      font-weight: 800;
      color: #e74c3c;
      margin-bottom: 1rem;
    }

    .add-to-cart-btn {
      width: 100%;
      padding: 0.9rem;
      background: #2d3436;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      padding: 2.5rem;
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #ddd;
    }

    .close-modal { font-size: 2rem; cursor: pointer; user-select:none; }

    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1.5rem;
      border-bottom: 1px solid #ddd;
      align-items: center;
    }

    .cart-item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
    }

    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }

    .cart-total {
      font-size: 1.8rem;
      font-weight: 800;
      text-align: right;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #2d3436;
    }

    .form-group { margin-bottom: 1.5rem; }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.9rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn-primary {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .btn-success {
      width: 100%;
      padding: 1.2rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .checkout-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      gap: 0.75rem;
    }

    .step {
      flex: 1;
      text-align: center;
      padding: 1rem;
      border-bottom: 3px solid #ddd;
      color: #636e72;
      font-weight: 600;
    }

    .step.active { border-bottom-color: #667eea; color: #667eea; }
    .step.completed { border-bottom-color: #27ae60; color: #27ae60; }

    .payment-option {
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      user-select: none;
    }

    .payment-option.selected {
      border-color: #667eea;
      background: #f0f3ff;
    }

    .order-summary {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
    }

    .summary-row.total {
      font-size: 1.4rem;
      font-weight: 800;
      padding-top: 1rem;
      border-top: 2px solid #ddd;
    }

    .hidden { display: none !important; }

    .admin-panel {
      max-width: 800px;
      margin: 3rem auto;
      padding: 2rem;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .image-upload-area {
      border: 3px dashed #ddd;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
    }

    .image-preview {
      max-width: 100%;
      max-height: 300px;
      margin-top: 1rem;
      border-radius: 8px;
    }

    .success-icon {
      font-size: 5rem;
      color: #27ae60;
    }

    .login-modal {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      max-width: 400px;
      width: 100%;
    }

    .login-modal h2 { margin-bottom: 2rem; color: #2d3436; }

    .product-list { margin-top: 2rem; }

    .product-item {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .product-item-image {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
    }

    .product-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-item-details { flex: 1; }

    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
      color: #636e72;
    }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .hero h1 { font-size: 2.3rem; }
      .modal-content { padding: 1.5rem; }
      .login-modal { padding: 2rem; }
    }
  </style>
</head>

<body>
  <header class="header">
    <nav class="nav-container">
      <a class="logo" onclick="showShop()">üëó Fashion Boutique</a>
      <ul class="nav-menu">
        <li><a onclick="showShop()">Shop</a></li>
        <li id="adminLink"><a onclick="promptAdminLogin()">Admin</a></li>
        <li>
          <div class="cart-icon" onclick="openCart()">
            üõí <span class="cart-count" id="cartCount">0</span>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <h1>Discover Your Perfect Style</h1>
    <p>Premium Fashion Collection - Cultural & Modern Clothing</p>
  </section>

  <div class="filter-section" id="shopSection">
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('cultural', this)">Cultural</button>
      <button class="filter-btn" onclick="filterProducts('tshirt', this)">T-Shirts</button>
      <button class="filter-btn" onclick="filterProducts('men', this)">Men</button>
      <button class="filter-btn" onclick="filterProducts('women', this)">Women</button>
    </div>
  </div>

  <div id="loadingProducts" class="loading">Loading products...</div>
  <div class="products-grid" id="productsGrid"></div>

  <!-- ADMIN SECTION -->
  <div id="adminSection" class="hidden">
    <div class="admin-panel">
      <h2 style="margin-bottom: 2rem;">Add New Product</h2>
      <form id="productForm">
        <div class="form-group">
          <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
            <p>üì∑ Upload Image</p>
            <input type="file" id="imageInput" accept="image/*" style="display:none;">
            <img id="imagePreview" class="image-preview hidden" alt="Preview">
          </div>
        </div>

        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="productName" required>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="productCategory" required>
              <option value="cultural">Cultural</option>
              <option value="tshirt">T-Shirt</option>
              <option value="dress">Dress</option>
            </select>
          </div>

          <div class="form-group">
            <label>Gender</label>
            <select id="productGender" required>
              <option value="men">Men</option>
              <option value="women">Women</option>
              <option value="kids">Kids</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Price (ETB)</label>
          <input type="number" id="productPrice" step="0.01" required>
        </div>

        <button type="submit" class="btn-primary">Add Product to GitHub</button>

        <p style="margin-top:1rem;color:#b23b3b;font-weight:600;">
          ‚ö†Ô∏è Don‚Äôt put GitHub tokens in frontend code. Use a backend function for saving.
        </p>
      </form>

      <h2 style="margin-top: 3rem; margin-bottom: 1rem;">Manage Products</h2>
      <div class="product-list" id="productList"></div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="modal" onclick="backdropClose(event, 'adminLoginModal')">
    <div class="login-modal" onclick="event.stopPropagation()">
      <h2>Admin Login</h2>
      <form id="adminLoginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="adminEmail" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="adminPassword" required>
        </div>
        <button type="submit" class="btn-primary">Login</button>

        <p style="margin-top: 1rem; text-align: center; color: #636e72; font-size: 0.9rem;">
          Owner: eshetuwek1@gmail.com
        </p>
      </form>
    </div>
  </div>

  <!-- CART MODAL -->
  <div id="cartModal" class="modal" onclick="backdropClose(event, 'cartModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Shopping Cart</h2>
        <span class="close-modal" onclick="closeCart()">&times;</span>
      </div>
      <div id="cartItems"></div>
      <div class="cart-total">Total: <span id="cartTotal">0</span> ETB</div>
      <button class="btn-success" onclick="proceedToCheckout()" style="margin-top: 1.5rem;">Checkout</button>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal" onclick="backdropClose(event, 'checkoutModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Checkout</h2>
        <span class="close-modal" onclick="closeCheckout()">&times;</span>
      </div>

      <div class="checkout-steps">
        <div class="step active" id="step1">Shipping</div>
        <div class="step" id="step2">Payment</div>
        <div class="step" id="step3">Review</div>
      </div>

      <div id="shippingForm">
        <h3 style="margin-bottom: 1.5rem;">Shipping Information</h3>

        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" id="firstName" required>
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="lastName" required>
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" required>
        </div>

        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="phone" required>
        </div>

        <div class="form-group">
          <label>Address</label>
          <input type="text" id="address" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="city" required>
          </div>
          <div class="form-group">
            <label>Region</label>
            <input type="text" id="state" required>
          </div>
        </div>

        <button type="button" class="btn-primary" onclick="goToPayment()">Continue</button>
      </div>

      <div id="paymentForm" class="hidden">
        <h3 style="margin-bottom: 1.5rem;">Payment Method</h3>

        <div class="payment-option" onclick="selectPayment('telebirr', this)">
          <h3>üì± Telebirr</h3>
          <p>Mobile payment</p>
        </div>

        <div class="payment-option" onclick="selectPayment('card', this)">
          <h3>üí≥ Card</h3>
          <p>Credit/Debit card</p>
        </div>

        <div class="payment-option" onclick="selectPayment('cod', this)">
          <h3>üíµ Cash on Delivery</h3>
        </div>

        <div id="telebirrForm" class="hidden" style="margin-top: 2rem;">
          <div class="form-group">
            <label>Telebirr Phone</label>
            <input type="tel" id="telebirrPhone">
          </div>
          <button type="button" class="btn-primary" onclick="goToReview()">Continue</button>
        </div>

        <div id="cardForm" class="hidden" style="margin-top: 2rem;">
          <div class="form-group">
            <label>Card Number</label>
            <input type="text" id="cardNumber">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Expiry</label>
              <input type="text" id="expiry" placeholder="MM/YY">
            </div>
            <div class="form-group">
              <label>CVV</label>
              <input type="text" id="cvv">
            </div>
          </div>
          <button type="button" class="btn-primary" onclick="goToReview()">Continue</button>
        </div>

        <div id="codForm" class="hidden" style="margin-top: 2rem;">
          <p style="padding: 1rem; background: #fff3cd; border-radius: 8px;">‚ö†Ô∏è Have cash ready on delivery</p>
          <button type="button" class="btn-primary" onclick="goToReview()">Continue</button>
        </div>
      </div>

      <div id="reviewForm" class="hidden">
        <h3 style="margin-bottom: 1.5rem;">Review Order</h3>

        <div class="order-summary">
          <h4>Order Summary</h4>
          <div id="reviewItems"></div>
          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="reviewSubtotal">0 ETB</span>
          </div>
          <div class="summary-row">
            <span>Shipping:</span>
            <span>50 ETB</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span id="reviewTotal">0 ETB</span>
          </div>
        </div>

        <div class="order-summary">
          <h4>Shipping</h4>
          <div id="reviewAddress"></div>
        </div>

        <div class="order-summary">
          <h4>Payment</h4>
          <div id="reviewPayment"></div>
        </div>

        <button class="btn-success" onclick="placeOrder()">Place Order</button>
      </div>

      <div id="orderConfirmation" class="hidden">
        <div style="text-align: center;">
          <div class="success-icon">‚úÖ</div>
          <h2>Order Placed!</h2>
          <p style="font-size: 1.5rem; font-weight: 800; margin: 1rem 0;" id="orderNumber"></p>
          <p style="color: #27ae60; margin: 1rem 0;">üìß Confirmation email sent!</p>
          <div id="confirmationDetails" style="text-align: left; margin: 2rem 0;"></div>
          <button class="btn-primary" onclick="continueShopping()">Continue Shopping</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script>
    // ===============================
    // IMPORTANT SECURITY WARNING:
    // Do NOT put GitHub tokens in frontend JS.
    // Use a backend function for saving to GitHub securely.
    // ===============================

    // ===== GitHub Config (READ works without token if repo/file is public) =====
    const GITHUB_USERNAME = "Eshetu70";
    const GITHUB_REPO = "fashion";
    const PRODUCTS_FILE = "products.json";

    // If you still insist on saving directly from frontend (NOT SAFE),
    // put a token here, but understand anyone can steal it:
    const GITHUB_TOKEN = ""; // <-- leave blank for safety

    // ===== EmailJS Configuration =====
    (function () {
      emailjs.init("048OB1q9jJCO0w5V0");
    })();

    const EMAILJS_SERVICE_ID = "service_i2ud88k";
    const EMAILJS_TEMPLATE_ID = "template_9cd4w2a";

    // ===== Admin Configuration (frontend-only; not secure) =====
    const ADMIN_EMAIL = "eshetuwek1@gmail.com";
    const ADMIN_PASSWORD = "admin123"; // change this

    const SHIPPING_COST = 50;

    let isAdminLoggedIn = false;
    let products = [];
    let cart = [];
    let currentFilter = "all";
    let currentImage = null;
    let selectedPayment = null;
    let orderData = {};

    // ===== Helpers =====
    function formatMoney(n) {
      const num = Number(n) || 0;
      return num.toFixed(0);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function backdropClose(e, modalId) {
      if (e.target && e.target.id === modalId) {
        if (modalId === "cartModal") closeCart();
        if (modalId === "checkoutModal") closeCheckout();
        if (modalId === "adminLoginModal") document.getElementById("adminLoginModal").classList.remove("active");
      }
    }

    // ===== GitHub API: LOAD products =====
    async function loadProductsFromGitHub() {
      const loading = document.getElementById("loadingProducts");
      try {
        // Public read endpoint (no token required for public repos)
        const url = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${PRODUCTS_FILE}`;
        const res = await fetch(url, { cache: "no-store" });

        if (res.ok) {
          const data = await res.json();
          products = Array.isArray(data) ? data : [];
        } else {
          products = [];
        }

        loading.classList.add("hidden");
        renderProducts();
      } catch (err) {
        console.error(err);
        loading.innerHTML = '<p style="color:#e74c3c;">Error loading products. Check repo/file path.</p>';
      }
    }

    // ===== GitHub API: SAVE products (requires token; not safe in frontend) =====
    async function saveProductsToGitHub() {
      if (!GITHUB_TOKEN) {
        alert("Saving is disabled because GITHUB_TOKEN is empty (for safety). Use a backend function to save securely.");
        return false;
      }

      try {
        // Get current SHA (if exists)
        const getUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PRODUCTS_FILE}`;
        const getResponse = await fetch(getUrl, {
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github+json",
          }
        });

        let sha = null;
        if (getResponse.ok) {
          const existing = await getResponse.json();
          sha = existing.sha;
        }

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2))));

        const putResponse = await fetch(getUrl, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github+json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: `Update products - ${new Date().toISOString()}`,
            content,
            sha
          })
        });

        if (!putResponse.ok) throw new Error("GitHub save failed");
        return true;
      } catch (error) {
        console.error("Error saving products:", error);
        alert("Error saving to GitHub. Check token/repo permissions.");
        return false;
      }
    }

    // ===== Render =====
    function filterProducts(category, btnEl) {
      currentFilter = category;
      document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
      if (btnEl) btnEl.classList.add("active");
      renderProducts();
    }

    function renderProducts() {
      const grid = document.getElementById("productsGrid");
      const filtered =
        currentFilter === "all"
          ? products
          : products.filter(p => p.category === currentFilter || p.gender === currentFilter);

      if (filtered.length === 0) {
        grid.innerHTML = `<div style="padding:1rem;color:#636e72;">No products found.</div>`;
        return;
      }

      grid.innerHTML = filtered.map(p => `
        <div class="product-card">
          <div class="product-image">
            <img src="${p.image || ''}" alt="${escapeHtml(p.name || 'Product')}">
          </div>
          <div class="product-details">
            <div class="product-category">${escapeHtml(p.category || '')} ‚Ä¢ ${escapeHtml(p.gender || '')}</div>
            <div class="product-name">${escapeHtml(p.name || '')}</div>
            ${p.description ? `<p style="font-size:0.9rem;color:#636e72;margin:0.5rem 0;">${escapeHtml(p.description)}</p>` : ""}
            <div class="product-price">${formatMoney(p.price)} ETB</div>
            <button class="add-to-cart-btn" onclick="addToCart(${p.id})">Add to Cart</button>
          </div>
        </div>
      `).join("");
    }

    function renderProductList() {
      const list = document.getElementById("productList");

      if (products.length === 0) {
        list.innerHTML = '<p style="color:#636e72;padding:1rem;">No products yet. Add your first product above!</p>';
        return;
      }

      list.innerHTML = products.map(p => `
        <div class="product-item">
          <div class="product-item-image">
            <img src="${p.image || ''}" alt="${escapeHtml(p.name || '')}">
          </div>
          <div class="product-item-details">
            <h3>${escapeHtml(p.name || '')}</h3>
            <p><strong>Category:</strong> ${escapeHtml(p.category || '')} | <strong>Gender:</strong> ${escapeHtml(p.gender || '')}</p>
            <p><strong>Price:</strong> ${formatMoney(p.price)} ETB</p>
            ${p.description ? `<p style="color:#636e72;">${escapeHtml(p.description)}</p>` : ""}
          </div>
          <div>
            <button class="btn-danger" onclick="deleteProduct(${p.id})">Delete</button>
          </div>
        </div>
      `).join("");
    }

    // ===== Cart =====
    function addToCart(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      cart.push(product);
      document.getElementById("cartCount").textContent = cart.length;
      alert("Added to cart!");
    }

    function openCart() {
      document.getElementById("cartModal").classList.add("active");

      if (cart.length === 0) {
        document.getElementById("cartItems").innerHTML =
          `<p style="padding:1rem;color:#636e72;">Your cart is empty.</p>`;
        document.getElementById("cartTotal").textContent = "0";
        return;
      }

      const total = cart.reduce((sum, item) => sum + (Number(item.price) || 0), 0);

      document.getElementById("cartItems").innerHTML = cart.map((item, i) => `
        <div class="cart-item">
          <div class="cart-item-image"><img src="${item.image || ''}" alt="${escapeHtml(item.name || '')}"></div>
          <div style="flex:1;">
            <div style="font-weight:700;">${escapeHtml(item.name || '')}</div>
            <div style="color:#e74c3c;font-weight:700;">${formatMoney(item.price)} ETB</div>
          </div>
          <button class="remove-btn" onclick="removeFromCart(${i})">Remove</button>
        </div>
      `).join("");

      document.getElementById("cartTotal").textContent = formatMoney(total);
    }

    function closeCart() {
      document.getElementById("cartModal").classList.remove("active");
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      document.getElementById("cartCount").textContent = cart.length;
      openCart();
    }

    function proceedToCheckout() {
      if (cart.length === 0) {
        alert("Cart is empty!");
        return;
      }
      closeCart();
      resetCheckoutUI();
      document.getElementById("checkoutModal").classList.add("active");
    }

    // ===== Checkout =====
    function closeCheckout() {
      document.getElementById("checkoutModal").classList.remove("active");
    }

    function goToPayment() {
      const requiredIds = ["firstName","lastName","email","phone","address","city","state"];
      const missing = requiredIds.some(id => !document.getElementById(id).value.trim());
      if (missing) {
        alert("Please fill all required fields");
        return;
      }

      orderData.shipping = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value.trim(),
      };

      document.getElementById("shippingForm").classList.add("hidden");
      document.getElementById("paymentForm").classList.remove("hidden");

      document.getElementById("step1").classList.add("completed");
      document.getElementById("step1").classList.remove("active");
      document.getElementById("step2").classList.add("active");
    }

    function selectPayment(method, optionEl) {
      selectedPayment = method;

      document.querySelectorAll(".payment-option").forEach(opt => opt.classList.remove("selected"));
      if (optionEl) optionEl.classList.add("selected");

      document.getElementById("telebirrForm").classList.add("hidden");
      document.getElementById("cardForm").classList.add("hidden");
      document.getElementById("codForm").classList.add("hidden");

      if (method === "telebirr") document.getElementById("telebirrForm").classList.remove("hidden");
      if (method === "card") document.getElementById("cardForm").classList.remove("hidden");
      if (method === "cod") document.getElementById("codForm").classList.remove("hidden");
    }

    function goToReview() {
      if (!selectedPayment) {
        alert("Please select a payment method.");
        return;
      }

      orderData.payment = selectedPayment;

      document.getElementById("paymentForm").classList.add("hidden");
      document.getElementById("reviewForm").classList.remove("hidden");

      document.getElementById("step2").classList.add("completed");
      document.getElementById("step2").classList.remove("active");
      document.getElementById("step3").classList.add("active");

      const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0), 0);

      document.getElementById("reviewItems").innerHTML = cart
        .map(item => `<div style="margin-bottom:0.5rem;">${escapeHtml(item.name)} - ${formatMoney(item.price)} ETB</div>`)
        .join("");

      document.getElementById("reviewSubtotal").textContent = formatMoney(subtotal) + " ETB";
      document.getElementById("reviewTotal").textContent = formatMoney(subtotal + SHIPPING_COST) + " ETB";

      document.getElementById("reviewAddress").innerHTML = `
        ${escapeHtml(orderData.shipping.firstName)} ${escapeHtml(orderData.shipping.lastName)}<br>
        ${escapeHtml(orderData.shipping.address)}<br>
        ${escapeHtml(orderData.shipping.city)}, ${escapeHtml(orderData.shipping.state)}<br>
        ${escapeHtml(orderData.shipping.phone)}
      `;

      document.getElementById("reviewPayment").textContent =
        selectedPayment === "telebirr" ? "Telebirr" :
        selectedPayment === "card" ? "Credit/Debit Card" :
        "Cash on Delivery";
    }

    function placeOrder() {
      if (!orderData.shipping || !orderData.payment) {
        alert("Please complete shipping and payment steps.");
        return;
      }

      const orderNum = "ORD" + Date.now();
      const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0), 0);
      const total = subtotal + SHIPPING_COST;

      const itemsText = cart.map(item => `${item.name} - ${item.price} ETB`).join("\n");

      // Send emails (best-effort)
      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email: "eshetuwek1@gmail.com",
        order_number: orderNum,
        customer_name: orderData.shipping.firstName + " " + orderData.shipping.lastName,
        customer_email: orderData.shipping.email,
        customer_phone: orderData.shipping.phone,
        delivery_address: `${orderData.shipping.address}, ${orderData.shipping.city}, ${orderData.shipping.state}`,
        payment_method: orderData.payment,
        total_amount: total + " ETB",
        items: itemsText
      }).catch(err => console.warn("EmailJS send failed:", err));

      document.getElementById("reviewForm").classList.add("hidden");
      document.getElementById("orderConfirmation").classList.remove("hidden");
      document.getElementById("orderNumber").textContent = "Order #" + orderNum;

      document.getElementById("confirmationDetails").innerHTML = `
        <div class="order-summary">
          <h4>Order Details</h4>
          ${cart.map(item => `<p>${escapeHtml(item.name)} - ${formatMoney(item.price)} ETB</p>`).join("")}
          <p><strong>Total: ${formatMoney(total)} ETB</strong></p>
          <p>Delivery to: ${escapeHtml(orderData.shipping.address)}, ${escapeHtml(orderData.shipping.city)}</p>
          <p>Payment: ${escapeHtml(orderData.payment)}</p>
        </div>
      `;

      cart = [];
      document.getElementById("cartCount").textContent = "0";
    }

    function continueShopping() {
      closeCheckout();
      resetCheckoutUI();
      showShop();
    }

    function resetCheckoutUI() {
      selectedPayment = null;
      orderData = {};

      document.getElementById("step1").classList.add("active");
      document.getElementById("step1").classList.remove("completed");
      document.getElementById("step2").classList.remove("active", "completed");
      document.getElementById("step3").classList.remove("active");

      document.getElementById("shippingForm").classList.remove("hidden");
      document.getElementById("paymentForm").classList.add("hidden");
      document.getElementById("reviewForm").classList.add("hidden");
      document.getElementById("orderConfirmation").classList.add("hidden");

      document.querySelectorAll(".payment-option").forEach(opt => opt.classList.remove("selected"));
      document.getElementById("telebirrForm").classList.add("hidden");
      document.getElementById("cardForm").classList.add("hidden");
      document.getElementById("codForm").classList.add("hidden");
    }

    // ===== Admin =====
    function promptAdminLogin() {
      if (isAdminLoggedIn) {
        showAdmin();
        return;
      }
      document.getElementById("adminLoginModal").classList.add("active");
    }

    function showShop() {
      document.getElementById("adminSection").classList.add("hidden");
      document.getElementById("shopSection").scrollIntoView({ behavior: "smooth" });
    }

    function showAdmin() {
      if (!isAdminLoggedIn) {
        alert("Please login as admin first!");
        promptAdminLogin();
        return;
      }
      document.getElementById("adminSection").classList.remove("hidden");
      renderProductList();
      window.scrollTo({ top: document.getElementById("adminSection").offsetTop, behavior: "smooth" });
    }

    async function deleteProduct(id) {
      if (!confirm("Delete this product?")) return;

      products = products.filter(p => p.id !== id);
      const saved = await saveProductsToGitHub();

      if (saved) {
        renderProducts();
        renderProductList();
        alert("Product deleted from GitHub!");
      }
    }

    // ===== DOM Ready =====
    document.addEventListener("DOMContentLoaded", () => {
      // Image input preview
      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          currentImage = ev.target.result;
          const img = document.getElementById("imagePreview");
          img.src = currentImage;
          img.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      });

      // Admin login form
      document.getElementById("adminLoginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("adminEmail").value.trim();
        const password = document.getElementById("adminPassword").value;

        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
          isAdminLoggedIn = true;
          document.getElementById("adminLoginModal").classList.remove("active");
          showAdmin();
          alert("Admin login successful!");
        } else {
          alert("Invalid credentials!");
        }
      });

      // Product form (FIXED)
      document.getElementById("productForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!isAdminLoggedIn) {
          alert("Please login as admin!");
          return;
        }

        if (!currentImage) {
          alert("Please upload an image.");
          return;
        }

        const newProduct = {
          id: Date.now(),
          name: document.getElementById("productName").value.trim(),
          description: document.getElementById("productDescription").value.trim(),
          category: document.getElementById("productCategory").value,
          gender: document.getElementById("productGender").value,
          price: Number(document.getElementById("productPrice").value) || 0,
          image: currentImage
        };

        products.unshift(newProduct);

        const saved = await saveProductsToGitHub();
        if (saved) {
          renderProducts();
          renderProductList();
          this.reset();
          document.getElementById("imagePreview").classList.add("hidden");
          currentImage = null;
          alert("Product added to GitHub successfully!");
        }
      });

      // Load products
      loadProductsFromGitHub();
    });
  </script>
</body>
</html>
