<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fashion Boutique - Professional Online Shopping</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #1a1a1a; background:#fff; }

    .header { background: linear-gradient(135deg, #2d3436 0%, #000000 100%); color: white; padding: 1rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; gap:1rem; }
    .logo { font-size: 1.8rem; font-weight: 800; color: white; text-decoration: none; cursor: pointer; user-select:none; }
    .nav-menu { display: flex; list-style: none; gap: 1.25rem; align-items: center; flex-wrap:wrap; }
    .nav-menu a { color: white; text-decoration: none; font-weight: 600; cursor: pointer; opacity: 0.95; }
    .nav-menu a:hover { opacity: 1; text-decoration: underline; }

    .pill {
      border: 1px solid rgba(255,255,255,0.25);
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      font-size: 0.95rem;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover { border-color: rgba(255,255,255,0.5); }

    .cart-count { background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: inline-flex; align-items: center; justify-content: center; margin-left: 0.35rem; }

    .hero { background: linear-gradient(135deg, rgba(0,0,0,0.62), rgba(0,0,0,0.35)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%23667eea" width="1200" height="600"/></svg>'); background-size: cover; color: white; padding: 6rem 2rem 4rem; text-align: center; }
    .hero h1 { font-size: 3.2rem; margin-bottom: 0.8rem; font-weight: 900; }
    .hero p { font-size: 1.05rem; opacity:0.95; }

    .filter-section { background: #f8f9fa; padding: 1.1rem; border-bottom: 2px solid #ddd; }
    .filter-container { max-width: 1400px; margin: 0 auto; display: flex; gap: 0.75rem; flex-wrap: wrap; padding: 0 0.5rem; }
    .filter-btn { padding: 0.65rem 1.15rem; border: 2px solid #2d3436; background: white; color: #2d3436; border-radius: 25px; cursor: pointer; font-weight: 800; }
    .filter-btn.active { background: #2d3436; color: white; }

    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.6rem; max-width: 1400px; margin: 2rem auto 3rem; padding: 0 2rem; }
    .product-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: all 0.25s; }
    .product-card:hover { transform: translateY(-6px); }
    .product-image { width: 100%; height: 320px; overflow: hidden; background:#f1f1f1; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; }
    .product-details { padding: 1.1rem 1.2rem 1.25rem; }
    .product-category { font-size: 0.82rem; color: #636e72; text-transform: uppercase; font-weight: 800; }
    .product-name { font-size: 1.15rem; font-weight: 900; margin: 0.35rem 0; }
    .product-price { font-size: 1.35rem; font-weight: 900; color: #e74c3c; margin: 0.8rem 0 0.9rem; }

    .btn { border:none; border-radius:10px; font-weight:900; cursor:pointer; }
    .btn-dark { background:#2d3436; color:#fff; padding:0.85rem; width:100%; }
    .btn-dark:hover { filter:brightness(1.05); }
    .btn-primary { padding: 0.85rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; }
    .btn-danger { padding: 0.7rem 1rem; background:#e74c3c; color:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; }
    .btn-ghost { padding: 0.7rem 1rem; background:#f1f3f5; color:#2d3436; border:none; border-radius:10px; font-weight:900; cursor:pointer; }
    .btn-ghost:hover { filter:brightness(0.98); }

    .hidden { display:none !important; }
    .loading { text-align:center; padding:3rem; font-size:1.1rem; color:#636e72; }

    .panel { max-width: 1100px; margin: 2rem auto 3rem; padding: 0 2rem; }
    .card { background:#fff; border-radius:18px; box-shadow:0 10px 35px rgba(0,0,0,0.08); padding:1.25rem; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    @media (max-width:900px){ .row{ grid-template-columns:1fr; } }

    label{ font-weight:800; font-size:0.95rem; }
    input, textarea, select {
      width:100%;
      padding:0.85rem;
      border:2px solid #ddd;
      border-radius:10px;
      font-size: 1rem;
      outline: none;
    }
    input:focus, textarea:focus, select:focus { border-color:#667eea; }

    /* Admin */
    .admin-panel { max-width:900px; margin:3rem auto; padding:2rem; background:white; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.1); }
    .image-upload-area { border:3px dashed #ddd; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; }
    .image-preview { max-width:100%; max-height:280px; margin-top:1rem; border-radius:10px; }
    .product-list { margin-top:1.5rem; }
    .product-item { background:white; padding:1rem; border-radius:14px; margin-bottom:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); display:flex; gap:1rem; align-items:center; }
    .product-item-image { width:92px; height:92px; border-radius:10px; overflow:hidden; background:#f1f1f1; }
    .product-item-image img { width:100%; height:100%; object-fit:cover; }
    .product-item-details { flex:1; }
    .product-actions { display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center;
      padding:1rem;
      z-index:2000;
    }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      padding:1.25rem;
    }
    .modal h2{ margin-bottom:0.35rem; }
    .modal .muted{ color:#636e72; font-size:0.95rem; margin-bottom:1rem; }
    .modal .actions{ display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1rem; }
    .link{ color:#667eea; font-weight:900; cursor:pointer; }
    .hr{ height:1px; background:#eee; margin:1rem 0; }

    /* Cart drawer */
    .drawer-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      z-index:2500;
      display:flex;
      justify-content:flex-end;
    }
    .drawer{
      width:min(420px, 100%);
      height:100%;
      background:#fff;
      padding:1rem;
      overflow:auto;
      box-shadow:-20px 0 60px rgba(0,0,0,0.2);
    }
    .cart-item{
      display:flex; gap:0.75rem;
      padding:0.85rem 0;
      border-bottom:1px solid #eee;
      align-items:center;
      position:relative;
    }
    .cart-thumb{ width:72px; height:72px; border-radius:12px; overflow:hidden; background:#f1f1f1; flex:0 0 auto; }
    .cart-thumb img{ width:100%; height:100%; object-fit:cover; }

    .qty{
      display:flex; align-items:center; gap:0.5rem; margin-top:0.35rem;
    }
    .qty button{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid #ddd;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .qty span{ font-weight:900; min-width:24px; text-align:center; display:inline-block; }

    .remove-x{
      position:absolute;
      top:10px;
      right:8px;
      width:30px;
      height:30px;
      border-radius:10px;
      border:1px solid rgba(231,76,60,0.35);
      background: rgba(231,76,60,0.08);
      color:#e74c3c;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .remove-x:hover{
      background: rgba(231,76,60,0.16);
      border-color: rgba(231,76,60,0.55);
    }

    /* Footer */
    .footer{
      margin-top: 2rem;
      background: #0b0b0b;
      color: #fff;
      padding: 2rem 1.5rem;
    }
    .footer-inner{
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 1.2rem;
    }
    .footer h3{ font-size: 1.1rem; margin-bottom: 0.5rem; }
    .footer p, .footer a{ color: rgba(255,255,255,0.85); text-decoration:none; }
    .footer a:hover{ text-decoration: underline; }
    .footer-bottom{
      max-width: 1400px;
      margin: 1.25rem auto 0;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.12);
      font-size: 0.95rem;
      color: rgba(255,255,255,0.75);
    }
    @media (max-width: 900px){
      .footer-inner{ grid-template-columns: 1fr; }
    }

    @media (max-width:768px){ .hero h1{font-size:2.2rem;} .products-grid{ padding:0 1rem; } .nav-container{ padding:0 1rem; } }
  </style>
</head>

<body>
  <header class="header">
    <nav class="nav-container">
      <a class="logo" onclick="showShop()">üëó Fashion Boutique</a>

      <ul class="nav-menu">
        <li><a onclick="showShop()">Shop</a></li>
        <li><a onclick="openOrders()">My Orders</a></li>
        <li><a onclick="openAdmin()">Admin</a></li>

        <li>
          <div class="pill" onclick="openAccountMenu()">
            üë§ <span id="authLabel">Login</span>
          </div>
        </li>

        <li>
          <div class="pill" onclick="openCart()">
            üõí Cart <span class="cart-count" id="cartCount">0</span>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <h1>Discover Your Perfect Style</h1>
    <p>Premium Fashion Collection - Cultural & Modern Clothing</p>
  </section>

  <div class="filter-section" id="shopSection">
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('bridal', this)">Bridal products</button>
      <button class="filter-btn" onclick="filterProducts('dinner_dress', this)">Dinner dress</button>
      <button class="filter-btn" onclick="filterProducts('short_dress', this)">Short dress</button>
      <button class="filter-btn" onclick="filterProducts('occasional_dress', this)">Occasional dress</button>
      <button class="filter-btn" onclick="filterProducts('suits', this)">Suits</button>
      <button class="filter-btn" onclick="filterProducts('pjs', this)">Pjs</button>
      <button class="filter-btn" onclick="filterProducts('sport_wears', this)">Sport wears</button>
    </div>
  </div>

  <div id="loadingProducts" class="loading">Loading products...</div>
  <div class="products-grid" id="productsGrid"></div>

  <!-- ORDERS PAGE -->
  <div id="ordersSection" class="panel hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
        <h2>üì¶ My Orders</h2>
        <button class="btn-primary" onclick="showShop()">Back to Shop</button>
      </div>
      <p style="color:#636e72;margin-top:0.25rem;">Login required to view your order history.</p>
      <div id="ordersList" style="margin-top:1rem;"></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="adminSection" class="hidden">
    <div class="admin-panel">
      <h2 style="margin-bottom: 0.5rem;">Admin</h2>

      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1.25rem;">
        <button class="btn-primary" onclick="setAdminKey()">Set Admin Key</button>
        <button class="btn-danger" onclick="logoutAdmin()">Logout</button>
        <button class="btn-primary" onclick="testAdminKey()">Test Admin Key</button>
      </div>

      <p style="color:#636e72;margin-bottom:1.25rem;">
        ‚úÖ Products and images are stored in MongoDB Atlas.
      </p>

      <h3 style="margin-bottom:1rem;">Add New Product</h3>

      <form id="productForm">
        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
          <p>üì∑ Upload Image (max 2MB)</p>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <img id="imagePreview" class="image-preview hidden" alt="Preview">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Product Name</b></label>
          <input id="productName" required placeholder="e.g., Bridal Dress">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Description</b></label>
          <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;">
          <div>
            <label><b>Category</b></label>
            <select id="productCategory" required>
              <option value="bridal">Bridal products</option>
              <option value="dinner_dress">Dinner dress</option>
              <option value="short_dress">Short dress</option>
              <option value="occasional_dress">Occasional dress</option>
              <option value="suits">Suits</option>
              <option value="pjs">Pjs</option>
              <option value="sport_wears">Sport wears</option>
            </select>
          </div>
          <div>
            <label><b>Gender</b></label>
            <select id="productGender" required>
              <option value="men">Men</option>
              <option value="women">Women</option>
              <option value="kids">Kids</option>
            </select>
          </div>
        </div>

        <div style="margin-top:1rem;">
          <label><b>Price (ETB)</b></label>
          <input type="number" id="productPrice" step="0.01" required placeholder="e.g., 1500">
        </div>

        <button class="btn-primary" id="addBtn" type="submit" style="width:100%;margin-top:1.2rem;">Add Product</button>
        <p id="adminStatus" style="margin-top:0.75rem;color:#636e72;"></p>
      </form>

      <h3 style="margin-top:2rem;margin-bottom:1rem;">Manage Products</h3>
      <div class="product-list" id="productList"></div>
    </div>
  </div>

  <!-- ‚úÖ EDIT PRODUCT MODAL -->
  <div id="editModal" class="modal-backdrop hidden" onclick="if(event.target.id==='editModal'){closeEditModal()}">
    <div class="modal" style="width:min(720px,100%);" onclick="event.stopPropagation()">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>‚úèÔ∏è Edit Product</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;border-radius:10px;" onclick="closeEditModal()">‚úï</button>
      </div>
      <p class="muted">Update product info. Image is optional (leave empty to keep current image).</p>

      <input type="hidden" id="editId">

      <div class="row" style="margin-top:0.75rem;">
        <div>
          <label>Product Name</label>
          <input id="editName" placeholder="Product name">
        </div>
        <div>
          <label>Price (ETB)</label>
          <input id="editPrice" type="number" step="0.01" placeholder="1500">
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Description</label>
        <textarea id="editDescription" rows="3" placeholder="Description..."></textarea>
      </div>

      <div class="row" style="margin-top:0.75rem;">
        <div>
          <label>Category</label>
          <select id="editCategory">
            <option value="bridal">Bridal products</option>
            <option value="dinner_dress">Dinner dress</option>
            <option value="short_dress">Short dress</option>
            <option value="occasional_dress">Occasional dress</option>
            <option value="suits">Suits</option>
            <option value="pjs">Pjs</option>
            <option value="sport_wears">Sport wears</option>
          </select>
        </div>
        <div>
          <label>Gender</label>
          <select id="editGender">
            <option value="men">Men</option>
            <option value="women">Women</option>
            <option value="kids">Kids</option>
          </select>
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Change Image (optional)</label>
        <input id="editImage" type="file" accept="image/*">
        <div style="margin-top:0.6rem;">
          <div style="font-weight:900;margin-bottom:0.3rem;">Preview</div>
          <img id="editPreview" style="max-width:100%;max-height:260px;border-radius:12px;display:none;" />
        </div>
      </div>

      <div class="actions" style="margin-top:1rem;">
        <button class="btn-primary" onclick="saveEditProduct()">Save Changes</button>
        <button class="btn-ghost" onclick="closeEditModal()">Cancel</button>
      </div>

      <p id="editMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:900;"></p>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal-backdrop hidden">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 id="authTitle">Login</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;border-radius:10px;" onclick="closeAuth()">‚úï</button>
      </div>
      <p class="muted" id="authSubtitle">Login to see your orders and checkout faster.</p>

      <div id="authFormLogin">
        <div style="margin-top:0.75rem;">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="you@example.com">
        </div>
        <div style="margin-top:0.75rem;">
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="actions">
          <button class="btn-primary" onclick="doLogin()">Login</button>
          <button class="btn btn-dark" style="width:auto;padding:0.85rem 1rem;" onclick="switchToRegister()">Create account</button>
        </div>
        <p id="authMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:800;"></p>
      </div>

      <div id="authFormRegister" class="hidden">
        <div style="margin-top:0.75rem;">
          <label>Full Name</label>
          <input id="regFullName" placeholder="Your name">
        </div>
        <div style="margin-top:0.75rem;">
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="you@example.com">
        </div>
        <div style="margin-top:0.75rem;">
          <label>Password (min 6)</label>
          <input id="regPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="actions">
          <button class="btn-primary" onclick="doRegister()">Register</button>
          <button class="btn btn-dark" style="width:auto;padding:0.85rem 1rem;" onclick="switchToLogin()">I already have account</button>
        </div>
        <p id="authMsg2" style="margin-top:0.75rem;color:#e74c3c;font-weight:800;"></p>
      </div>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cartDrawer" class="drawer-backdrop hidden" onclick="if(event.target.id==='cartDrawer'){closeCart()}">
    <div class="drawer">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>üõí Cart</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;" onclick="closeCart()">‚úï</button>
      </div>

      <div id="cartItems"></div>

      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;font-weight:900;">
        <span>Subtotal</span>
        <span id="cartSubtotal">0 ETB</span>
      </div>

      <button class="btn btn-dark" style="width:100%;margin-top:1rem;" onclick="continueShopping()">Continue Shopping</button>
      <button class="btn-primary" style="width:100%;margin-top:0.6rem;" onclick="openCheckout()">Checkout</button>
      <button class="btn btn-dark" style="width:100%;margin-top:0.6rem;" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal-backdrop hidden">
    <div class="modal" style="width:min(720px,100%);">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>‚úÖ Checkout</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;border-radius:10px;" onclick="closeCheckout()">‚úï</button>
      </div>
      <p class="muted">Fill your details, choose payment, and place your order.</p>

      <div class="row">
        <div>
          <label>Full Name</label>
          <input id="ckFullName" placeholder="Full name">
        </div>
        <div>
          <label>Phone</label>
          <input id="ckPhone" placeholder="+251...">
        </div>
      </div>

      <div class="row" style="margin-top:0.75rem;">
        <div>
          <label>Email (optional)</label>
          <input id="ckEmail" placeholder="you@example.com">
        </div>
        <div>
          <label>City</label>
          <input id="ckCity" placeholder="Addis Ababa">
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Address</label>
        <input id="ckAddress" placeholder="Street, building, etc...">
      </div>

      <div style="margin-top:0.75rem;">
        <label>Country</label>
        <input id="ckCountry" value="Ethiopia">
      </div>

      <div style="margin-top:0.75rem;">
        <label>Order Notes (optional)</label>
        <textarea id="ckNotes" rows="3" placeholder="Any special request..."></textarea>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Payment Method</label>
          <select id="ckPaymentMethod" onchange="renderPaymentFields()">
            <option value="cash">Cash on Delivery</option>
            <option value="card">Card</option>
            <option value="telebirr">Telebirr</option>
          </select>
        </div>
        <div>
          <label>Total</label>
          <input id="ckTotal" disabled>
        </div>
      </div>

      <div id="telebirrFields" class="hidden" style="margin-top:0.75rem;">
        <div class="row">
          <div>
            <label>Telebirr Reference / Transaction ID</label>
            <input id="ckTelebirrRef" placeholder="e.g., TB123456789">
          </div>
          <div>
            <label>Upload Payment Proof (optional)</label>
            <input id="ckProof" type="file" accept="image/*">
          </div>
        </div>
        <p style="color:#636e72;margin-top:0.5rem;font-size:0.95rem;">
          If you pay via Telebirr, upload a screenshot as proof (optional) and add the transaction ID.
        </p>
      </div>

      <div id="cardFields" class="hidden" style="margin-top:0.75rem;">
        <p style="color:#636e72;font-size:0.95rem;">
          Card processing is a demo placeholder. You can integrate Stripe/PayPal later.
        </p>
      </div>

      <div class="actions" style="margin-top:1rem;">
        <button class="btn-primary" onclick="placeOrder()">Place Order</button>
        <button class="btn btn-dark" style="width:auto;padding:0.85rem 1rem;" onclick="closeCheckout()">Cancel</button>
      </div>

      <p id="checkoutMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:900;"></p>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-inner">
      <div>
        <h3>üëó Fashion Boutique</h3>
        <p>Premium fashion collection ‚Äî cultural & modern clothing.</p>
      </div>

      <div>
        <h3>Contact</h3>
        <p>üìû Phone: <a href="tel:+251913127880">+251913127880</a></p>
        <p>‚úâÔ∏è Email: <a href="mailto:info@fashionboutique.com">info@fashionboutique.com</a></p>
      </div>

      <div>
        <h3>Hours</h3>
        <p>Mon‚ÄìSat: 9:00 AM ‚Äì 7:00 PM</p>
        <p>Sunday: Closed</p>
      </div>
    </div>

    <div class="footer-bottom">
      ¬© <span id="yy"></span> Fashion Boutique. All rights reserved.
    </div>
  </footer>

  <script>
    const API_BASE =
      (location.hostname === "localhost" || location.hostname === "127.0.0.1")
        ? "http://localhost:3000"
        : "https://fashion-2tif.onrender.com";

    let products = [];
    let currentFilter = "all";
    let cart = JSON.parse(localStorage.getItem("FASHION_CART") || "[]");

    const ADMIN_KEY_STORAGE = "FASHION_ADMIN_KEY";
    const getAdminKey = () => localStorage.getItem(ADMIN_KEY_STORAGE) || "";

    const AUTH_TOKEN_KEY = "FASHION_AUTH_TOKEN";
    const getToken = () => localStorage.getItem(AUTH_TOKEN_KEY) || "";
    const setToken = (t) => localStorage.setItem(AUTH_TOKEN_KEY, t);
    const clearToken = () => localStorage.removeItem(AUTH_TOKEN_KEY);

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function formatMoney(n){ return (Number(n)||0).toFixed(0); }

    async function readJsonSafe(res){
      const text = await res.text();
      try { return { text, json: JSON.parse(text) }; }
      catch { return { text, json: null }; }
    }

    function setStatus(msg, isError=false){
      const el = document.getElementById("adminStatus");
      if(!el) return;
      el.textContent = msg || "";
      el.style.color = isError ? "#e74c3c" : "#636e72";
    }

    function saveCart(){
      localStorage.setItem("FASHION_CART", JSON.stringify(cart));
      updateCartCount();
    }

    function updateCartCount(){
      const count = cart.reduce((s, it) => s + (Number(it.qty)||1), 0);
      document.getElementById("cartCount").textContent = count;
    }

    function cartSubtotal(){
      return cart.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0);
    }

    function showShop(){
      document.getElementById("ordersSection").classList.add("hidden");
      document.getElementById("adminSection").classList.add("hidden");
      document.getElementById("shopSection").scrollIntoView({ behavior:"smooth" });
    }

    function continueShopping(){
      closeCart();
      showShop();
    }

    function openAdmin(){
      document.getElementById("ordersSection").classList.add("hidden");
      document.getElementById("adminSection").classList.remove("hidden");
      renderProductList();
      window.scrollTo({ top: document.getElementById("adminSection").offsetTop, behavior: "smooth" });
    }

    async function openOrders(){
      document.getElementById("adminSection").classList.add("hidden");
      document.getElementById("ordersSection").classList.remove("hidden");
      window.scrollTo({ top: document.getElementById("ordersSection").offsetTop, behavior:"smooth" });

      if(!getToken()){
        document.getElementById("ordersList").innerHTML =
          '<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#636e72;">Please login to view orders. <span class="link" onclick="openAuth()">Login</span></div>';
        return;
      }
      await loadMyOrders();
    }

    async function loadProducts(){
      const loading = document.getElementById("loadingProducts");
      try {
        const res = await fetch(API_BASE + "/api/products", { cache: "no-store" });
        const data = await res.json();
        products = Array.isArray(data) ? data : [];
        loading.classList.add("hidden");
        renderProducts();
        renderProductList();
      } catch (err) {
        console.error(err);
        loading.innerHTML = '<p style="color:#e74c3c;">Failed to load products from backend.</p>';
      }
    }

    function filterProducts(category, btnEl){
      currentFilter = category;
      document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
      if (btnEl) btnEl.classList.add("active");
      renderProducts();
    }

    function renderProducts(){
      const grid = document.getElementById("productsGrid");
      const filtered = (currentFilter === "all")
        ? products
        : products.filter(p => p.category === currentFilter || p.gender === currentFilter);

      if (!filtered.length) {
        grid.innerHTML = `<div style="padding:1rem;color:#636e72;">No products found.</div>`;
        return;
      }

      grid.innerHTML = filtered.map(p => `
        <div class="product-card">
          <div class="product-image">
            <img src="${p.image || ''}" alt="${escapeHtml(p.name || 'Product')}" onerror="this.style.display='none'">
          </div>
          <div class="product-details">
            <div class="product-category">${escapeHtml(p.category || '')} ‚Ä¢ ${escapeHtml(p.gender || '')}</div>
            <div class="product-name">${escapeHtml(p.name || '')}</div>
            ${p.description ? `<p style="font-size:0.95rem;color:#636e72;margin:0.4rem 0;">${escapeHtml(p.description)}</p>` : ""}
            <div class="product-price">${formatMoney(p.price)} ETB</div>
            <button class="btn btn-dark" onclick="addToCart('${String(p.id).replaceAll("'","")}')">Add to Cart</button>
          </div>
        </div>
      `).join("");
    }

    function addToCart(productId){
      const p = products.find(x => String(x.id) === String(productId));
      if(!p) return alert("Product not found");

      const existing = cart.find(x => String(x.productId) === String(productId));
      if(existing){
        existing.qty = (Number(existing.qty)||1) + 1;
      }else{
        cart.push({
          productId: p.id,
          name: p.name,
          price: Number(p.price)||0,
          qty: 1,
          image: p.image || ""
        });
      }
      saveCart();
      openCart();
    }

    function removeFromCart(productId){
      cart = cart.filter(x => String(x.productId) !== String(productId));
      saveCart();
      renderCart();
    }

    function changeQty(productId, delta){
      const it = cart.find(x => String(x.productId) === String(productId));
      if(!it) return;
      it.qty = Math.max(1, (Number(it.qty)||1) + delta);
      saveCart();
      renderCart();
    }

    function clearCart(){
      if(!confirm("Clear cart?")) return;
      cart = [];
      saveCart();
      renderCart();
    }

    function openCart(){
      document.getElementById("cartDrawer").classList.remove("hidden");
      renderCart();
    }

    function closeCart(){
      document.getElementById("cartDrawer").classList.add("hidden");
    }

    function renderCart(){
      const box = document.getElementById("cartItems");
      if(cart.length === 0){
        box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;margin-top:1rem;">Your cart is empty.</div>`;
        document.getElementById("cartSubtotal").textContent = "0 ETB";
        return;
      }

      box.innerHTML = cart.map(it => `
        <div class="cart-item">
          <div class="cart-thumb"><img src="${it.image || ''}" onerror="this.style.display='none'"></div>

          <div style="flex:1;">
            <div style="font-weight:900;">${escapeHtml(it.name || "")}</div>
            <div style="color:#e74c3c;font-weight:900;margin-top:0.2rem;">${formatMoney(it.price)} ETB</div>

            <div class="qty">
              <button onclick="changeQty('${String(it.productId).replaceAll("'","")}', -1)">-</button>
              <span>${Number(it.qty)||1}</span>
              <button onclick="changeQty('${String(it.productId).replaceAll("'","")}', 1)">+</button>
            </div>
          </div>

          <div class="remove-x" title="Remove" onclick="removeFromCart('${String(it.productId).replaceAll("'","")}')">‚úï</div>
        </div>
      `).join("");

      document.getElementById("cartSubtotal").textContent = `${formatMoney(cartSubtotal())} ETB`;
    }

    function openCheckout(){
      if(cart.length === 0) return alert("Cart is empty");
      if(!getToken()){
        alert("Please login first to checkout.");
        openAuth();
        return;
      }

      document.getElementById("checkoutMsg").textContent = "";
      document.getElementById("ckTotal").value = formatMoney(cartSubtotal()) + " ETB";
      renderPaymentFields();
      document.getElementById("checkoutModal").classList.remove("hidden");
    }

    function closeCheckout(){
      document.getElementById("checkoutModal").classList.add("hidden");
    }

    function renderPaymentFields(){
      const method = document.getElementById("ckPaymentMethod").value;
      document.getElementById("telebirrFields").classList.toggle("hidden", method !== "telebirr");
      document.getElementById("cardFields").classList.toggle("hidden", method !== "card");
    }

    async function placeOrder(){
      const msgEl = document.getElementById("checkoutMsg");
      msgEl.textContent = "";

      const fullName = document.getElementById("ckFullName").value.trim();
      const phone = document.getElementById("ckPhone").value.trim();
      const email = document.getElementById("ckEmail").value.trim();
      const address = document.getElementById("ckAddress").value.trim();
      const city = document.getElementById("ckCity").value.trim();
      const country = document.getElementById("ckCountry").value.trim();
      const notes = document.getElementById("ckNotes").value.trim();
      const paymentMethod = document.getElementById("ckPaymentMethod").value;
      const telebirrRef = document.getElementById("ckTelebirrRef").value.trim();
      const proofFile = document.getElementById("ckProof").files[0];

      if(!fullName) return msgEl.textContent = "Full name is required";
      if(!phone) return msgEl.textContent = "Phone is required";
      if(!address) return msgEl.textContent = "Address is required";

      const fd = new FormData();
      fd.append("items", JSON.stringify(cart.map(it => ({
        productId: it.productId,
        name: it.name,
        price: it.price,
        qty: it.qty
      }))));

      fd.append("fullName", fullName);
      fd.append("phone", phone);
      fd.append("email", email);
      fd.append("address", address);
      fd.append("city", city);
      fd.append("country", country);
      fd.append("notes", notes);
      fd.append("paymentMethod", paymentMethod);
      fd.append("telebirrRef", telebirrRef);
      if(proofFile) fd.append("paymentProof", proofFile);

      try{
        const res = await fetch(API_BASE + "/api/orders", {
          method: "POST",
          headers: { "Authorization": "Bearer " + getToken() },
          body: fd
        });

        const { text, json } = await readJsonSafe(res);
        if(!res.ok){
          alert(`ORDER FAILED\nStatus: ${res.status}\n${text}`);
          throw new Error(json?.error || json?.details || text || "Order failed");
        }

        alert("‚úÖ Order placed! Order ID: " + (json?.order?.orderId || ""));
        closeCheckout();
        closeCart();

        cart = [];
        saveCart();

        await openOrders();
      }catch(e){
        msgEl.textContent = e.message;
      }
    }

    function openAuth(){
      document.getElementById("authModal").classList.remove("hidden");
      switchToLogin();
    }
    function closeAuth(){
      document.getElementById("authModal").classList.add("hidden");
    }

    function switchToRegister(){
      document.getElementById("authTitle").textContent = "Create Account";
      document.getElementById("authSubtitle").textContent = "Register to track your orders anytime.";
      document.getElementById("authFormLogin").classList.add("hidden");
      document.getElementById("authFormRegister").classList.remove("hidden");
      document.getElementById("authMsg").textContent = "";
      document.getElementById("authMsg2").textContent = "";
    }

    function switchToLogin(){
      document.getElementById("authTitle").textContent = "Login";
      document.getElementById("authSubtitle").textContent = "Login to see your orders and checkout faster.";
      document.getElementById("authFormRegister").classList.add("hidden");
      document.getElementById("authFormLogin").classList.remove("hidden");
      document.getElementById("authMsg").textContent = "";
      document.getElementById("authMsg2").textContent = "";
    }

    function setAuthLabel(){
      const lbl = document.getElementById("authLabel");
      lbl.textContent = getToken() ? "Account" : "Login";
    }

    function openAccountMenu(){
      if(!getToken()){
        openAuth();
        return;
      }
      const choice = prompt("Type: 1 = My Orders, 2 = Logout");
      if(choice === "1") openOrders();
      if(choice === "2"){ clearToken(); setAuthLabel(); alert("Logged out."); }
    }

    async function doRegister(){
      const msg = document.getElementById("authMsg2");
      msg.textContent = "";
      const fullName = document.getElementById("regFullName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      try{
        const res = await fetch(API_BASE + "/api/auth/register", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ fullName, email, password })
        });
        const { text, json } = await readJsonSafe(res);
        if(!res.ok) throw new Error(json?.error || json?.details || text || "Register failed");

        setToken(json.token);
        setAuthLabel();
        closeAuth();
        alert("‚úÖ Account created! You are logged in.");
      }catch(e){
        msg.textContent = e.message;
      }
    }

    async function doLogin(){
      const msg = document.getElementById("authMsg");
      msg.textContent = "";
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      try{
        const res = await fetch(API_BASE + "/api/auth/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email, password })
        });
        const { text, json } = await readJsonSafe(res);
        if(!res.ok) throw new Error(json?.error || json?.details || text || "Login failed");

        setToken(json.token);
        setAuthLabel();
        closeAuth();
        alert("‚úÖ Logged in!");
      }catch(e){
        msg.textContent = e.message;
      }
    }

    async function loadMyOrders(){
      const box = document.getElementById("ordersList");
      box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;">Loading...</div>`;

      try{
        const res = await fetch(API_BASE + "/api/orders/my", {
          headers: { "Authorization": "Bearer " + getToken() }
        });
        const { text, json } = await readJsonSafe(res);
        if(!res.ok) throw new Error(json?.error || json?.details || text || "Failed to load orders");

        const orders = Array.isArray(json) ? json : [];
        if(orders.length === 0){
          box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;">No orders yet.</div>`;
          return;
        }

        box.innerHTML = orders.map(o => {
          const itemsHtml = (o.items || []).map(it => `
            <div style="display:flex;gap:0.75rem;align-items:center;padding:0.5rem 0;border-bottom:1px solid #f3f3f3;">
              <div style="flex:1;">
                <div style="font-weight:900;">${escapeHtml(it.name || "")}</div>
                <div style="color:#636e72;font-weight:800;font-size:0.95rem;">Qty: ${Number(it.qty)||1} ‚Ä¢ ${formatMoney(it.price)} ETB</div>
              </div>
            </div>
          `).join("");

          return `
            <div style="border:1px solid #eee;border-radius:16px;padding:1rem;margin-bottom:1rem;">
              <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <div>
                  <div style="font-weight:1000;font-size:1.05rem;">Order: ${escapeHtml(o.orderId || "")}</div>
                  <div style="color:#636e72;font-weight:800;font-size:0.95rem;">
                    Status: ${escapeHtml(o.status || "placed")} ‚Ä¢ Payment: ${escapeHtml(o.payment?.method || "")} (${escapeHtml(o.payment?.status || "pending")})
                  </div>
                </div>
                <div style="font-weight:1000;color:#e74c3c;font-size:1.05rem;">${formatMoney(o.total)} ETB</div>
              </div>

              <div style="margin-top:0.75rem;">
                ${itemsHtml}
              </div>

              <div style="margin-top:0.75rem;color:#636e72;font-weight:800;font-size:0.95rem;">
                Placed: ${new Date(o.createdAt).toLocaleString()}
              </div>
            </div>
          `;
        }).join("");
      }catch(e){
        box.innerHTML = `<div style="padding:1rem;color:#e74c3c;border:1px solid #eee;border-radius:14px;">${escapeHtml(e.message)}</div>`;
      }
    }

    function setAdminKey() {
      const k = prompt("Enter ADMIN_API_KEY:");
      if (!k) return;
      localStorage.setItem(ADMIN_KEY_STORAGE, k.trim());
      alert("Admin key saved on this browser.");
    }
    function logoutAdmin() {
      localStorage.removeItem(ADMIN_KEY_STORAGE);
      alert("Admin key removed.");
    }

    async function testAdminKey(){
      const k = getAdminKey();
      if (!k) return alert("Admin key not set. Click 'Set Admin Key' first.");
      try{
        const fd = new FormData();
        fd.append("name", "TEST");
        fd.append("category", "bridal");
        fd.append("gender", "men");
        fd.append("price", "1");

        const res = await fetch(API_BASE + "/api/products", {
          method: "POST",
          headers: { "x-admin-key": k },
          body: fd
        });

        const { text, json } = await readJsonSafe(res);
        if (res.status === 401) return alert("‚ùå Unauthorized. Admin key is wrong.");
        if (res.status === 400 && (json?.error || "").toLowerCase().includes("image")) {
          return alert("‚úÖ Admin key is correct (auth passed).");
        }
        alert("Response: " + res.status + "\n" + text);
      }catch(e){
        alert("Test error: " + e.message);
      }
    }

    function renderProductList(){
      const list = document.getElementById("productList");
      if (!products.length) {
        list.innerHTML = '<p style="color:#636e72;padding:1rem;">No products yet.</p>';
        return;
      }

      list.innerHTML = products.map(p => `
        <div class="product-item">
          <div class="product-item-image">
            <img src="${p.image || ''}" alt="${escapeHtml(p.name || '')}" onerror="this.style.display='none'">
          </div>
          <div class="product-item-details">
            <h3>${escapeHtml(p.name || '')}</h3>
            <p><b>Category:</b> ${escapeHtml(p.category || '')} | <b>Gender:</b> ${escapeHtml(p.gender || '')}</p>
            <p><b>Price:</b> ${formatMoney(p.price)} ETB</p>
          </div>
          <div class="product-actions">
            <button class="btn-ghost" onclick="openEditProduct('${String(p.id).replaceAll("'","")}')">Edit</button>
            <button class="btn-danger" onclick="deleteProduct('${String(p.id).replaceAll("'","")}')">Delete</button>
          </div>
        </div>
      `).join("");
    }

    function openEditProduct(id){
      const p = products.find(x => String(x.id) === String(id));
      if(!p) return alert("Product not found");

      document.getElementById("editMsg").textContent = "";
      document.getElementById("editId").value = p.id;
      document.getElementById("editName").value = p.name || "";
      document.getElementById("editPrice").value = Number(p.price) || 0;
      document.getElementById("editDescription").value = p.description || "";
      document.getElementById("editCategory").value = p.category || "bridal";
      document.getElementById("editGender").value = p.gender || "men";

      const prev = document.getElementById("editPreview");
      if(p.image){
        prev.src = p.image;
        prev.style.display = "block";
      } else {
        prev.style.display = "none";
      }

      document.getElementById("editImage").value = "";
      document.getElementById("editModal").classList.remove("hidden");
    }

    function closeEditModal(){
      document.getElementById("editModal").classList.add("hidden");
    }

    async function saveEditProduct(){
      const adminKey = getAdminKey();
      if(!adminKey) return alert("Admin key not set. Click 'Set Admin Key' first.");

      const id = document.getElementById("editId").value;
      const name = document.getElementById("editName").value.trim();
      const price = document.getElementById("editPrice").value;
      const description = document.getElementById("editDescription").value.trim();
      const category = document.getElementById("editCategory").value;
      const gender = document.getElementById("editGender").value;
      const file = document.getElementById("editImage").files[0];

      const msg = document.getElementById("editMsg");
      msg.textContent = "";

      if(!name) return msg.textContent = "Name is required";
      if(!price) return msg.textContent = "Price is required";

      if(file && file.size > 2 * 1024 * 1024) return msg.textContent = "Image too large (max 2MB)";

      const fd = new FormData();
      fd.append("name", name);
      fd.append("price", price);
      fd.append("description", description);
      fd.append("category", category);
      fd.append("gender", gender);
      if(file) fd.append("image", file);

      try{
        const res = await fetch(API_BASE + "/api/products/" + encodeURIComponent(id), {
          method: "PUT",
          headers: { "x-admin-key": adminKey },
          body: fd
        });

        const { text, json } = await readJsonSafe(res);
        if(!res.ok) throw new Error(json?.error || json?.details || text || "Update failed");

        alert("‚úÖ Updated!");
        closeEditModal();
        await loadProducts();
      }catch(e){
        msg.textContent = e.message;
      }
    }

    document.addEventListener("change", (e) => {
      if(e.target && e.target.id === "editImage"){
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const prev = document.getElementById("editPreview");
          prev.src = ev.target.result;
          prev.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    async function deleteProduct(id){
      if (!confirm("Delete this product?")) return;

      const adminKey = getAdminKey();
      if (!adminKey) return alert("Admin key not set. Click 'Set Admin Key' first.");

      try{
        const res = await fetch(API_BASE + "/api/products/" + encodeURIComponent(id), {
          method: "DELETE",
          headers: { "x-admin-key": adminKey }
        });

        const { text, json } = await readJsonSafe(res);
        if (!res.ok) throw new Error(json?.error || json?.details || text || "Delete failed");

        alert("Deleted!");
        await loadProducts();
      }catch(e){
        alert("Delete error: " + e.message);
      }
    }

    async function addProduct(formEl){
      const adminKey = getAdminKey();
      if (!adminKey) return alert("Admin key not set. Click 'Set Admin Key' first.");

      const file = document.getElementById("imageInput").files[0];
      if (!file) return alert("Please select an image file.");
      if (file.size > 2 * 1024 * 1024) return alert("Image too large. Please use an image under 2MB.");

      const fd = new FormData();
      fd.append("image", file);
      fd.append("name", document.getElementById("productName").value.trim());
      fd.append("description", document.getElementById("productDescription").value.trim());
      fd.append("category", document.getElementById("productCategory").value);
      fd.append("gender", document.getElementById("productGender").value);
      fd.append("price", document.getElementById("productPrice").value);

      const btn = document.getElementById("addBtn");
      btn.disabled = true;
      btn.textContent = "Uploading...";
      setStatus("Uploading image + saving product...");

      try{
        const res = await fetch(API_BASE + "/api/products", {
          method: "POST",
          headers: { "x-admin-key": adminKey },
          body: fd
        });

        const { text, json } = await readJsonSafe(res);
        if (!res.ok) throw new Error(json?.error || json?.details || text || "Failed to add product");

        alert("Product added!");
        setStatus("Saved ‚úÖ");

        formEl.reset();
        document.getElementById("imagePreview").classList.add("hidden");

        await loadProducts();
      }catch(e){
        setStatus("Error: " + e.message, true);
        alert("Add error: " + e.message);
      }finally{
        btn.disabled = false;
        btn.textContent = "Add Product";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // footer year
      const yy = document.getElementById("yy");
      if (yy) yy.textContent = new Date().getFullYear();

      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = document.getElementById("imagePreview");
          img.src = ev.target.result;
          img.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("productForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await addProduct(e.target);
      });

      updateCartCount();
      setAuthLabel();
      loadProducts();
    });
  </script>
</body>
</html>
