<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fashion Boutique - Professional Online Shopping</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #1a1a1a; }

    .header { background: linear-gradient(135deg, #2d3436 0%, #000000 100%); color: white; padding: 1rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.8rem; font-weight: 800; color: white; text-decoration: none; cursor: pointer; user-select:none; }
    .nav-menu { display: flex; list-style: none; gap: 2rem; align-items: center; }
    .nav-menu a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; }

    .cart-icon { position: relative; font-size: 1.5rem; cursor: pointer; user-select: none; }
    .cart-count { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }

    .hero { background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%23667eea" width="1200" height="600"/></svg>'); background-size: cover; color: white; padding: 6rem 2rem 4rem; text-align: center; }
    .hero h1 { font-size: 3.5rem; margin-bottom: 1rem; font-weight: 800; }

    .filter-section { background: #f8f9fa; padding: 1.5rem; border-bottom: 2px solid #ddd; }
    .filter-container { max-width: 1400px; margin: 0 auto; display: flex; gap: 1rem; flex-wrap: wrap; }
    .filter-btn { padding: 0.7rem 1.3rem; border: 2px solid #2d3436; background: white; color: #2d3436; border-radius: 25px; cursor: pointer; font-weight: 600; }
    .filter-btn.active { background: #2d3436; color: white; }

    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; max-width: 1400px; margin: 3rem auto; padding: 0 2rem; }
    .product-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: all 0.3s; }
    .product-card:hover { transform: translateY(-10px); }
    .product-image { width: 100%; height: 320px; overflow: hidden; background:#f1f1f1; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; }
    .product-details { padding: 1.5rem; }
    .product-category { font-size: 0.85rem; color: #636e72; text-transform: uppercase; font-weight: 600; }
    .product-name { font-size: 1.2rem; font-weight: 700; margin: 0.5rem 0; }
    .product-price { font-size: 1.4rem; font-weight: 800; color: #e74c3c; margin-bottom: 1rem; }
    .add-to-cart-btn { width: 100%; padding: 0.9rem; background: #2d3436; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }

    .hidden { display:none !important; }
    .loading { text-align:center; padding:3rem; font-size:1.2rem; color:#636e72; }

    .admin-panel { max-width:800px; margin:3rem auto; padding:2rem; background:white; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.1); }
    .image-upload-area { border:3px dashed #ddd; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; }
    .image-preview { max-width:100%; max-height:300px; margin-top:1rem; border-radius:8px; }

    .product-list { margin-top:2rem; }
    .product-item { background:white; padding:1.5rem; border-radius:10px; margin-bottom:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.1); display:flex; gap:1rem; align-items:center; }
    .product-item-image { width:100px; height:100px; border-radius:8px; overflow:hidden; background:#f1f1f1; }
    .product-item-image img { width:100%; height:100%; object-fit:cover; }
    .product-item-details { flex:1; }

    .btn-primary { padding: 0.9rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-danger { padding: 0.7rem 1rem; background:#e74c3c; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-secondary { padding: 0.7rem 1rem; background:#2d3436; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; }

    .notice {
      max-width: 1400px;
      margin: 1rem auto 0;
      padding: 0 2rem;
      color: #2d3436;
      font-size: 0.95rem;
    }
    .notice code{ background:#f1f1f1; padding:0.15rem 0.35rem; border-radius:6px; }

    input, textarea, select {
      width:100%;
      padding:0.8rem;
      border:2px solid #ddd;
      border-radius:8px;
      font-size: 1rem;
      outline: none;
    }
    input:focus, textarea:focus, select:focus { border-color:#667eea; }

    /* MODALS */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal{
      width: min(900px, 100%);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    .modal-header{
      padding: 1rem 1.25rem;
      background: #2d3436;
      color: #fff;
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-body{ padding: 1.25rem; }
    .modal-footer{ padding: 1rem 1.25rem; display:flex; gap:0.75rem; justify-content:flex-end; border-top:1px solid #eee; }
    .xbtn{ cursor:pointer; font-size: 1.2rem; user-select:none; }

    .cart-row{
      display:grid;
      grid-template-columns: 70px 1fr 110px 140px 40px;
      gap: 0.75rem;
      align-items:center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #eee;
    }
    .cart-row img{ width:70px; height:70px; object-fit:cover; border-radius:10px; background:#f1f1f1; }
    .qty{
      display:flex; gap: 0.5rem; align-items:center; justify-content:center;
    }
    .qty button{
      width:32px; height:32px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;
    }

    @media (max-width:768px){
      .hero h1{font-size:2.3rem;}
      .cart-row{ grid-template-columns: 60px 1fr 90px 40px; }
      .hide-sm{ display:none; }
    }
  </style>
</head>

<body>
  <header class="header">
    <nav class="nav-container">
      <a class="logo" onclick="showShop()">üëó Fashion Boutique</a>
      <ul class="nav-menu">
        <li><a onclick="showShop()">Shop</a></li>
        <li><a onclick="openAdmin()">Admin</a></li>
        <li>
          <div class="cart-icon" onclick="openCart()">
            üõí <span class="cart-count" id="cartCount">0</span>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <h1>Discover Your Perfect Style</h1>
    <p>Premium Fashion Collection - Cultural & Modern Clothing</p>
  </section>

  <div class="notice">
    Backend: <code id="backendLabel"></code>
  </div>

  <div class="filter-section" id="shopSection">
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('cultural', this)">Cultural</button>
      <button class="filter-btn" onclick="filterProducts('tshirt', this)">T-Shirts</button>
      <button class="filter-btn" onclick="filterProducts('men', this)">Men</button>
      <button class="filter-btn" onclick="filterProducts('women', this)">Women</button>
    </div>
  </div>

  <div id="loadingProducts" class="loading">Loading products...</div>
  <div class="products-grid" id="productsGrid"></div>

  <!-- CART MODAL -->
  <div id="cartModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div><b>üõí Your Cart</b></div>
        <div class="xbtn" onclick="closeCart()">‚úñ</div>
      </div>
      <div class="modal-body" id="cartBody"></div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeCart()">Continue Shopping</button>
        <button class="btn-primary" onclick="openCheckout()">Checkout</button>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div><b>‚úÖ Checkout</b></div>
        <div class="xbtn" onclick="closeCheckout()">‚úñ</div>
      </div>
      <div class="modal-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div>
            <label><b>Full Name *</b></label>
            <input id="cFullName" placeholder="Full name">
          </div>
          <div>
            <label><b>Phone *</b></label>
            <input id="cPhone" placeholder="Phone number">
          </div>
        </div>

        <div style="margin-top:1rem;">
          <label><b>Email</b></label>
          <input id="cEmail" placeholder="Optional email">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Address *</b></label>
          <textarea id="cAddress" rows="2" placeholder="Delivery address"></textarea>
        </div>

        <div style="margin-top:1rem;">
          <label><b>Note</b></label>
          <textarea id="cNote" rows="2" placeholder="Optional note"></textarea>
        </div>

        <hr style="margin:1rem 0;">

        <div>
          <label><b>Payment Method *</b></label>
          <select id="payMethod" onchange="togglePaymentFields()">
            <option value="cash">Cash on Delivery</option>
            <option value="card">Card</option>
            <option value="telebirr">Telebirr</option>
          </select>
        </div>

        <div id="cardInfo" class="hidden" style="margin-top:1rem;">
          <p style="color:#636e72;margin-bottom:0.5rem;">
            ‚úÖ Card payment can be integrated later (Stripe). For now we record as <b>submitted</b>.
          </p>
        </div>

        <div id="telebirrInfo" class="hidden" style="margin-top:1rem;">
          <label><b>Telebirr Transaction ID *</b></label>
          <input id="teleTxnId" placeholder="Enter Telebirr Txn ID">
          <div style="margin-top:0.8rem;">
            <label><b>Upload Telebirr Confirmation Screenshot *</b></label>
            <input type="file" id="teleProof" accept="image/*">
            <p style="color:#636e72;font-size:0.9rem;margin-top:0.4rem;">Max 2MB</p>
          </div>
        </div>

        <div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-size:1.1rem;"><b>Total:</b> <span id="checkoutTotal">0</span> ETB</div>
          <div id="checkoutStatus" style="color:#636e72;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeCheckout()">Cancel</button>
        <button class="btn-primary" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="adminSection" class="hidden">
    <div class="admin-panel">
      <h2 style="margin-bottom: 0.75rem;">Admin</h2>

      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1.5rem;">
        <button class="btn-primary" onclick="setAdminKey()">Set Admin Key</button>
        <button class="btn-danger" onclick="logoutAdmin()">Logout</button>
        <button class="btn-primary" onclick="testAdminKey()">Test Admin Key</button>
      </div>

      <h3 style="margin-bottom:1rem;">Add New Product</h3>

      <form id="productForm">
        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
          <p>üì∑ Upload Image (max 2MB)</p>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <img id="imagePreview" class="image-preview hidden" alt="Preview">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Product Name</b></label>
          <input id="productName" required placeholder="e.g., Ethiopian Dress">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Description</b></label>
          <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;">
          <div>
            <label><b>Category</b></label>
            <select id="productCategory" required>
              <option value="cultural">Cultural</option>
              <option value="tshirt">T-Shirt</option>
              <option value="dress">Dress</option>
            </select>
          </div>
          <div>
            <label><b>Gender</b></label>
            <select id="productGender" required>
              <option value="men">Men</option>
              <option value="women">Women</option>
              <option value="kids">Kids</option>
            </select>
          </div>
        </div>

        <div style="margin-top:1rem;">
          <label><b>Price (ETB)</b></label>
          <input type="number" id="productPrice" step="0.01" required placeholder="e.g., 1500">
        </div>

        <button class="btn-primary" id="addBtn" type="submit" style="width:100%;margin-top:1.2rem;">Add Product</button>
        <p id="adminStatus" style="margin-top:0.75rem;color:#636e72;"></p>
      </form>

      <h3 style="margin-top:2rem;margin-bottom:1rem;">Manage Products</h3>
      <div class="product-list" id="productList"></div>
    </div>
  </div>

<script>
  // =======================
  // CONFIG
  // =======================
  const API_BASE =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:3000"
      : "https://fashion-2tif.onrender.com";

  document.getElementById("backendLabel").textContent = API_BASE;

  // =======================
  // STATE
  // =======================
  let products = [];
  let currentFilter = "all";
  let cart = JSON.parse(localStorage.getItem("FASHION_CART") || "[]");

  const ADMIN_KEY_STORAGE = "FASHION_ADMIN_KEY";
  const getAdminKey = () => localStorage.getItem(ADMIN_KEY_STORAGE) || "";

  // =======================
  // HELPERS
  // =======================
  function saveCart(){ localStorage.setItem("FASHION_CART", JSON.stringify(cart)); updateCartBadge(); }
  function updateCartBadge(){
    const count = cart.reduce((a,i)=>a+(i.qty||0),0);
    document.getElementById("cartCount").textContent = String(count);
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function formatMoney(n){ return (Number(n)||0).toFixed(0); }

  function setStatus(msg, isError=false){
    const el = document.getElementById("adminStatus");
    el.textContent = msg || "";
    el.style.color = isError ? "#e74c3c" : "#636e72";
  }
  async function readJsonSafe(res){
    const text = await res.text();
    try { return { text, json: JSON.parse(text) }; }
    catch { return { text, json: null }; }
  }

  function showShop(){
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("shopSection").scrollIntoView({ behavior: "smooth" });
  }
  function openAdmin(){
    document.getElementById("adminSection").classList.remove("hidden");
    renderProductList();
    window.scrollTo({ top: document.getElementById("adminSection").offsetTop, behavior: "smooth" });
  }

  // =======================
  // CART
  // =======================
  function addToCart(productId){
    const p = products.find(x => String(x.id) === String(productId));
    if (!p) return alert("Product not found");

    const existing = cart.find(x => String(x.id) === String(productId));
    if (existing) existing.qty += 1;
    else cart.push({ id: p.id, name: p.name, price: Number(p.price)||0, image: p.image, qty: 1 });

    saveCart();
    alert("Added to cart ‚úÖ");
  }

  function removeFromCart(productId){
    cart = cart.filter(x => String(x.id) !== String(productId));
    saveCart();
    renderCart();
  }

  function changeQty(productId, delta){
    const item = cart.find(x => String(x.id) === String(productId));
    if (!item) return;
    item.qty += delta;
    if (item.qty <= 0) removeFromCart(productId);
    else { saveCart(); renderCart(); }
  }

  function cartTotal(){
    return cart.reduce((sum,i)=> sum + (Number(i.price)||0) * (Number(i.qty)||0), 0);
  }

  function openCart(){
    renderCart();
    document.getElementById("cartModal").classList.remove("hidden");
  }
  function closeCart(){
    document.getElementById("cartModal").classList.add("hidden");
  }

  function renderCart(){
    const body = document.getElementById("cartBody");
    if (!cart.length){
      body.innerHTML = `<p style="color:#636e72;">Your cart is empty.</p>`;
      return;
    }

    body.innerHTML = `
      ${cart.map(i => `
        <div class="cart-row">
          <img src="${i.image || ''}" onerror="this.style.display='none'">
          <div>
            <b>${escapeHtml(i.name)}</b><br>
            <span style="color:#636e72">${formatMoney(i.price)} ETB</span>
          </div>
          <div class="qty">
            <button onclick="changeQty('${String(i.id)}', -1)">‚àí</button>
            <b>${i.qty}</b>
            <button onclick="changeQty('${String(i.id)}', 1)">+</button>
          </div>
          <div class="hide-sm" style="text-align:right;">
            <b>${formatMoney((i.price||0)*(i.qty||0))} ETB</b>
          </div>
          <div style="text-align:right;">
            <button class="btn-danger" style="padding:0.4rem 0.6rem;" onclick="removeFromCart('${String(i.id)}')">X</button>
          </div>
        </div>
      `).join("")}

      <div style="display:flex;justify-content:flex-end;margin-top:1rem;font-size:1.1rem;">
        <b>Total: ${formatMoney(cartTotal())} ETB</b>
      </div>
    `;
  }

  // =======================
  // CHECKOUT
  // =======================
  function openCheckout(){
    if (!cart.length) return alert("Cart is empty");
    closeCart();
    document.getElementById("checkoutTotal").textContent = formatMoney(cartTotal());
    document.getElementById("checkoutStatus").textContent = "";
    document.getElementById("checkoutModal").classList.remove("hidden");
    togglePaymentFields();
  }
  function closeCheckout(){
    document.getElementById("checkoutModal").classList.add("hidden");
  }

  function togglePaymentFields(){
    const method = document.getElementById("payMethod").value;
    document.getElementById("cardInfo").classList.toggle("hidden", method !== "card");
    document.getElementById("telebirrInfo").classList.toggle("hidden", method !== "telebirr");
  }

  async function fileToDataUrl(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ""));
      r.onerror = () => reject(new Error("File read failed"));
      r.readAsDataURL(file);
    });
  }

  async function placeOrder(){
    const fullName = document.getElementById("cFullName").value.trim();
    const phone = document.getElementById("cPhone").value.trim();
    const email = document.getElementById("cEmail").value.trim();
    const address = document.getElementById("cAddress").value.trim();
    const note = document.getElementById("cNote").value.trim();

    if (!fullName || !phone || !address) return alert("Name, phone, and address are required.");

    const method = document.getElementById("payMethod").value;

    const payload = {
      items: cart.map(i => ({
        id: i.id,
        name: i.name,
        price: Number(i.price)||0,
        qty: Number(i.qty)||0,
        subtotal: (Number(i.price)||0) * (Number(i.qty)||0)
      })),
      total: cartTotal(),
      customer: { fullName, phone, email, address, note },
      payment: { method }
    };

    if (method === "telebirr"){
      const txnId = document.getElementById("teleTxnId").value.trim();
      const proofFile = document.getElementById("teleProof").files[0];
      if (!txnId) return alert("Telebirr Transaction ID is required.");
      if (!proofFile) return alert("Telebirr proof image is required.");
      if (proofFile.size > 2 * 1024 * 1024) return alert("Proof image too large (max 2MB).");

      payload.payment.telebirrTxnId = txnId;
      payload.payment.proofImage = await fileToDataUrl(proofFile);
    }

    const btn = document.getElementById("placeOrderBtn");
    btn.disabled = true;
    btn.textContent = "Placing...";
    document.getElementById("checkoutStatus").textContent = "Submitting order...";

    try{
      const res = await fetch(API_BASE + "/api/orders/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const { text, json } = await readJsonSafe(res);

      if (!res.ok){
        alert(`ORDER FAILED\nStatus: ${res.status}\n${text}`);
        throw new Error(json?.error || json?.details || text || "Checkout failed");
      }

      alert("‚úÖ Order placed successfully!\nOrder ID: " + (json?.order?.orderId || ""));
      cart = [];
      saveCart();
      closeCheckout();
      await loadProducts();
    }catch(e){
      alert("Checkout error: " + e.message);
      document.getElementById("checkoutStatus").textContent = "Error: " + e.message;
    }finally{
      btn.disabled = false;
      btn.textContent = "Place Order";
    }
  }

  // =======================
  // ADMIN
  // =======================
  function setAdminKey() {
    const k = prompt("Enter ADMIN_API_KEY:");
    if (!k) return;
    localStorage.setItem(ADMIN_KEY_STORAGE, k.trim());
    alert("Admin key saved on this browser.");
  }
  function logoutAdmin() {
    localStorage.removeItem(ADMIN_KEY_STORAGE);
    alert("Admin key removed.");
  }

  async function testAdminKey(){
    const k = getAdminKey();
    if (!k) return alert("Admin key not set. Click 'Set Admin Key' first.");

    try{
      const fd = new FormData();
      fd.append("name", "TEST");
      fd.append("category", "cultural");
      fd.append("gender", "men");
      fd.append("price", "1");

      const res = await fetch(API_BASE + "/api/products", {
        method: "POST",
        headers: { "x-admin-key": k },
        body: fd
      });

      const { text, json } = await readJsonSafe(res);

      if (res.status === 401) return alert("‚ùå Unauthorized. Admin key is wrong.");
      if (res.status === 400 && (json?.error || "").toLowerCase().includes("image")) {
        return alert("‚úÖ Admin key is correct (auth passed).");
      }
      alert("Response: " + res.status + "\n" + text);
    }catch(e){
      alert("Test error: " + e.message);
    }
  }

  function renderProductList(){
    const list = document.getElementById("productList");
    if (!products.length) {
      list.innerHTML = '<p style="color:#636e72;padding:1rem;">No products yet.</p>';
      return;
    }

    list.innerHTML = products.map(p => `
      <div class="product-item">
        <div class="product-item-image">
          <img src="${p.image || ''}" alt="${escapeHtml(p.name || '')}" onerror="this.style.display='none'">
        </div>
        <div class="product-item-details">
          <h3>${escapeHtml(p.name || '')}</h3>
          <p><b>Category:</b> ${escapeHtml(p.category || '')} | <b>Gender:</b> ${escapeHtml(p.gender || '')}</p>
          <p><b>Price:</b> ${formatMoney(p.price)} ETB</p>
        </div>
        <div>
          <button class="btn-danger" onclick="deleteProduct('${String(p.id).replaceAll("'","")}')">Delete</button>
        </div>
      </div>
    `).join("");
  }

  async function deleteProduct(id){
    if (!confirm("Delete this product?")) return;

    const adminKey = getAdminKey();
    if (!adminKey) return alert("Admin key not set. Click 'Set Admin Key' first.");

    try{
      const res = await fetch(API_BASE + "/api/products/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "x-admin-key": adminKey }
      });

      const { text, json } = await readJsonSafe(res);
      if (!res.ok) throw new Error(json?.error || json?.details || text || "Delete failed");

      alert("Deleted!");
      await loadProducts();
    }catch(e){
      alert("Delete error: " + e.message);
    }
  }

  async function addProduct(formEl){
    const adminKey = getAdminKey();
    if (!adminKey) return alert("Admin key not set. Click 'Set Admin Key' first.");

    const file = document.getElementById("imageInput").files[0];
    if (!file) return alert("Please select an image file.");
    if (file.size > 2 * 1024 * 1024) return alert("Image too large. Please use an image under 2MB.");

    const fd = new FormData();
    fd.append("image", file);
    fd.append("name", document.getElementById("productName").value.trim());
    fd.append("description", document.getElementById("productDescription").value.trim());
    fd.append("category", document.getElementById("productCategory").value);
    fd.append("gender", document.getElementById("productGender").value);
    fd.append("price", document.getElementById("productPrice").value);

    const btn = document.getElementById("addBtn");
    btn.disabled = true;
    btn.textContent = "Uploading...";
    setStatus("Uploading image + saving product...");

    try{
      const res = await fetch(API_BASE + "/api/products", {
        method: "POST",
        headers: { "x-admin-key": adminKey },
        body: fd
      });

      const { text, json } = await readJsonSafe(res);
      if (!res.ok) throw new Error(json?.error || json?.details || text || "Failed to add product");

      alert("Product added!");
      setStatus("Saved ‚úÖ");
      formEl.reset();
      document.getElementById("imagePreview").classList.add("hidden");
      await loadProducts();
    }catch(e){
      setStatus("Error: " + e.message, true);
      alert("Add error: " + e.message);
    }finally{
      btn.disabled = false;
      btn.textContent = "Add Product";
    }
  }

  // =======================
  // PRODUCTS
  // =======================
  async function loadProducts(){
    const loading = document.getElementById("loadingProducts");
    try {
      const res = await fetch(API_BASE + "/api/products", { cache: "no-store" });
      const data = await res.json();
      products = Array.isArray(data) ? data : [];
      loading.classList.add("hidden");
      renderProducts();
      renderProductList();
    } catch (err) {
      console.error(err);
      loading.innerHTML = '<p style="color:#e74c3c;">Failed to load products from backend.</p>';
    }
  }

  function filterProducts(category, btnEl){
    currentFilter = category;
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    if (btnEl) btnEl.classList.add("active");
    renderProducts();
  }

  function renderProducts(){
    const grid = document.getElementById("productsGrid");
    const filtered = (currentFilter === "all")
      ? products
      : products.filter(p => p.category === currentFilter || p.gender === currentFilter);

    if (!filtered.length) {
      grid.innerHTML = `<div style="padding:1rem;color:#636e72;">No products found.</div>`;
      return;
    }

    grid.innerHTML = filtered.map(p => `
      <div class="product-card">
        <div class="product-image">
          <img src="${p.image || ''}" alt="${escapeHtml(p.name || 'Product')}" onerror="this.style.display='none'">
        </div>
        <div class="product-details">
          <div class="product-category">${escapeHtml(p.category || '')} ‚Ä¢ ${escapeHtml(p.gender || '')}</div>
          <div class="product-name">${escapeHtml(p.name || '')}</div>
          ${p.description ? `<p style="font-size:0.9rem;color:#636e72;margin:0.5rem 0;">${escapeHtml(p.description)}</p>` : ""}
          <div class="product-price">${formatMoney(p.price)} ETB</div>
          <button class="add-to-cart-btn" onclick="addToCart('${String(p.id)}')">Add to Cart</button>
        </div>
      </div>
    `).join("");
  }

  // =======================
  // DOM READY
  // =======================
  document.addEventListener("DOMContentLoaded", () => {
    updateCartBadge();

    document.getElementById("imageInput").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("imagePreview");
        img.src = ev.target.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addProduct(e.target);
    });

    loadProducts();
  });
</script>

</body>
</html>
